---
title: "Load data and cleaning"
author: "Justin Williams"
date: "5/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(vroom)
library(sf)
library(tigris)
options(tigris_use_cache = TRUE)
library(leaflet)
library(htmlwidgets)
library(BAMMtools)
library(tmap)
library(RSocrata)
library(dotenv)
```

Set working directory

```{r setwd}
setwd("/Users/justinwilliams/projects/nyc_covid_tracker")
```

## Load in Covid data.

Download master repo from NYC DoH Github.

```{r doh-github}
download.file(url = 
    "https://github.com/nychealth/coronavirus-data/archive/refs/heads/master.zip",
    destfile = "covid_data_master.zip")

unzip(zipfile = "covid_data_master.zip")
```

This is only at the borough level. For MODZCTA will need to read from raw csv in github.

### NYC DOHMH Github data

**trends** - sort through trends folder to see what data will actually be useful for this analysis.

*Summary Numbers*
- `antibody-by-week.csv` could be useful in quantifying percent positive per date (in full weeks Sun-Sat), however only goes bock too *April 11th, 2020*. 
- `cases-by-day.csv` could be useful to calculate overall case amount when slider is moved for date range.

*Geography*
- `caserate-by-modzcta.csv` this has rate of cases per 100,000 people by week and modzcta so could help for case rate, but not count. Could have graduated symbology be case rate or choropleth colors.
- `test-rate-by-modzcta.csv` - rate of molecular testing per 100,000 people stratified by week. 
- `percentpositve-by-modzcta.csv` - percent of people who tested positive with a molecular test stratified by week.

### Load in data

Load in some .csv data

```{r load-data}
caserate <- vroom("./coronavirus-data-master/trends/caserate-by-modzcta.csv")
testrate <- vroom("./coronavirus-data-master/trends/testrate-by-modzcta.csv")
percentpos <- vroom("./coronavirus-data-master/trends/percentpositive-by-modzcta.csv")
```

Load in MODZCTA geography

```{r MODACTA-geography}
modzcta <-  st_read("./coronavirus-data-master/Geography-resources/MODZCTA_2010.shp")

zcta_conv <- vroom("./coronavirus-data-master/Geography-resources/ZCTA-to-MODZCTA.csv", delim = ",")

# read from nyc open data
# this get population and zcta
modzcta_3 <-st_read("https://data.cityofnewyork.us/resource/pri4-ifjk.geojson")
```

### Clean Data

Delete columns and pivot longer.

Build function.

```{r drop-col-pivot}
# function to drop columns and pivot longer
pivot_covid_long <- function(df, names_prefix, values_to) {
  df %>% 
    select(-c(2:7)) %>% 
    pivot_longer(2:178, names_to = "modzcta",
                 names_prefix = names_prefix,
                 values_to = values_to)
}

# apply to dfs
caserates_long <- pivot_covid_long(caserate, names_prefix = "CASERATE_", 
                              values_to = "caserate")
testrates_long <- pivot_covid_long(testrate, names_prefix = "TESTRATE_",
                              values_to = "testrate")
percpos_long <- pivot_covid_long(percentpos, names_prefix = "PCTPOS_",
                            values_to = "percpos")
```

Join df's

```{r join-format}
# join all df's
all <-caserates_long %>% 
  left_join(percpos_long, by = c("week_ending", "modzcta")) %>% 
  left_join(testrates_long, by = c("week_ending", "modzcta"))
```

Add in spatial data.

```{r join-spatial-data, warning=FALSE}
# join with modzcta
all_sf <-geo_join(modzcta, all, 
                  "MODZCTA","modzcta",
                  how = "inner")

# convert week ending column to date
all_sf$week_ending <- as.Date(all_sf$week_ending, format = "%m/%d/%Y")
```

### Leaflet map

Write code for leaflet map prior to creating Shiny App.
Redo this for just one week-ending, its too much data and takes forever to render.

```{r leaflet-map}
# segment for week ending 2022-01-01
all_sf_jan_01_22 <- all_sf[all_sf$week_ending == "2022-01-01",]

# set labels
labels <- sprintf(
  "<strong>%s</strong><br/>%g cases per 100,000 people",
  all_sf_jan_01_22$MODZCTA, round(all_sf_jan_01_22$caserate)) %>% 
  lapply(htmltools::HTML)

# set bins
bins <- getJenksBreaks(all_sf_jan_01_22$caserate, 6) # get natural breaks
bins <- map(.x = bins, round) %>% 
  unlist() # round

# set color palette
pal <- colorBin(palette = "PuBu",
                bins = bins, 
                domain = all_sf_jan_01_22$caserate)

# plot map
leaflet_map <- all_sf_jan_01_22 %>% 
   st_transform(4326) %>% 
   leaflet() %>%
   setView(lng = -74.0060,lat = 40.7128,zoom = 10) %>% 
   addProviderTiles(providers$CartoDB.Positron) %>% 
   addPolygons(label = labels,
               weight = 0.25,
               color = "white",
               smoothFactor = 0.5,
               opacity = 1,
               fillOpacity = 0.7,
               fillColor = pal(all_sf_jan_01_22$caserate),
               highlightOptions = highlightOptions(weight = 1,
                                                   color = "#666",
                                                   fillOpacity = 0.7,
                                                   bringToFront = T)) %>% 
  addLegend("bottomright",
            pal = pal,
            values = ~caserate,
            title = "Cases per 100,000",
            opacity = 0.7)


leaflet_map
```

### Create custom projection

I can't seem to get a basemap in 2263, will have to come back to this.
Will see if I can make a version in **tmap** in 2263
```{r custom-proj}
# epsg2263 <- leafletCRS(crsClass = "L.Proj.CRS", code = "EPSG:2263",
#   proj4def = "+proj=lcc +lat_1=41.03333333333333 +lat_2=40.66666666666666 +lat_0=40.16666666666666 +lon_0=-74 +x_0=300000.0000000001 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs",
#   resolutions = 2^(13:-1),
#   origin = c(0, 0)
# )
# 
# # plot map
# leaflet_map_2263 <- all_sf_jan_01_22 %>% 
#    leaflet(options = leafletOptions(crs = epsg2263)) %>% 
#    addProviderTiles(providers$CartoDB.Positron) %>% 
#    addPolygons(label = labels,
#                weight = 0.25,
#                color = "white",
#                smoothFactor = 0.5,
#                opacity = 1,
#                fillOpacity = 0.7,
#                fillColor = pal(all_sf_jan_01_22$caserate),
#                highlightOptions = highlightOptions(weight = 1,
#                                                    color = "#666",
#                                                    fillOpacity = 0.7,
#                                                    bringToFront = T)) %>% 
#   addLegend("bottomright",
#             pal = pal,
#             values = ~caserate,
#             title = "Cases per 100,000",
#             opacity = 0.7)
# 
# leaflet_map_2263

```

### TMAP version

Ok they access the same basemaps as leaflet, and 2263 is not available.

```{r tmap}
tmap_mode("view")

tm_shape(all_sf_jan_01_22) +
  tm_fill(col = "caserate",
          palette = "PuBu",
          alpha = 0.7,
          title = "Cases per 100,000",
          popup.vars = c("MODZCTA" = "MODZCTA"),
          legend.format = scales::comma_format(),
          style = "jenks") +
  tm_polygons(border.col = "white",
              border.alpha = 0.7,
              lwd = 0.5) +
  tm_layout(title = "Case rate per 100,000 Week Ending Jan 1, 2022") +
  tm_scale_bar() +
  tm_view(projection = 2263)

```

### Export 

Export dataframe for use in Shiny App.

```{r export-data}
saveRDS(all_sf, file = "./nyc_covid_tracker_app/all_sf.rds")
```

```{r}
glimpse(all_sf)
```

### How to design Shiny App

  - sliderbar on bottom with week ending?
  - 3 tabs for case, test and perc pos.
  - legend should have about 5 breaks?
  - maybe a line graph as well for total cases in another tab?
  - total death count? Hosp count?
  - possibly graduated symbology?


